<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>In The Dark</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #000;
      color: #fff;
      font-family: system-ui, sans-serif;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Pre-splash screen */
    #pre-splash {
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 3rem;
    }

    #pre-splash.hidden {
      display: none;
    }

    #pre-splash h1 {
      font-size: 3rem;
      font-weight: bold;
      letter-spacing: 4px;
      text-transform: uppercase;
      text-shadow: 0 0 20px rgba(0, 170, 255, 0.5);
    }

    #pre-splash .start-prompt {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }

    #pre-splash button {
      background: #0af;
      border: none;
      color: #000;
      padding: 16px 48px;
      font-size: 1.2rem;
      font-weight: bold;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    #pre-splash button:hover {
      background: #fff;
      transform: scale(1.05);
    }

    #pre-splash .press-key {
      font-size: 0.9rem;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 2px;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 1; }
    }

    /* Start screen (main splash) */
    #start-screen {
      text-align: center;
      display: none;
    }

    #start-screen.active {
      display: block;
    }

    #start-screen h1 {
      font-size: 2rem;
      margin-bottom: 1rem;
    }

    #start-screen p {
      font-size: 1.2rem;
      opacity: 0.8;
    }

    #start-screen .version {
      font-size: 0.8rem;
      opacity: 0.5;
      margin-top: 0.5rem;
    }

    #start-screen .buttons {
      margin-top: 2rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      align-items: center;
    }

    #start-screen button {
      background: #222;
      border: 2px solid #444;
      color: #fff;
      padding: 12px 32px;
      font-size: 1rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 200px;
    }

    #start-screen button:hover {
      background: #333;
      border-color: #0af;
      color: #0af;
    }

    #start-screen button.hidden {
      display: none;
    }

    #start-screen .options {
      margin-top: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      align-items: center;
    }

    #start-screen .option-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
    }

    #start-screen .option-row input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #0af;
      cursor: pointer;
    }

    #start-screen .option-row label {
      font-size: 0.9rem;
      color: #aaa;
      cursor: pointer;
    }

    #start-screen .option-row:hover label {
      color: #0af;
    }

    #start-screen .how-to-play {
      margin-top: 2rem;
      text-align: left;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid #333;
      border-radius: 8px;
      padding: 16px 20px;
      max-width: 420px;
    }

    #start-screen .how-to-play h2 {
      font-size: 0.9rem;
      color: #0af;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      text-align: center;
    }

    #start-screen .how-to-play p {
      font-size: 0.85rem;
      color: #aaa;
      margin-bottom: 10px;
      line-height: 1.5;
      text-align: left;
    }

    #start-screen .how-to-play p:last-child {
      margin-bottom: 0;
    }

    #start-screen .how-to-play .tip {
      color: #fc0;
      font-style: italic;
    }

    #start-screen .how-to-play kbd {
      background: #222;
      border: 1px solid #444;
      border-radius: 3px;
      padding: 2px 6px;
      font-family: monospace;
      font-size: 0.8rem;
      color: #fff;
    }

    #game-screen {
      display: none;
      text-align: center;
    }

    #game-screen.active {
      display: block;
    }


    /* Minimap */
    #minimap {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 100;
    }

    .minimap-wrapper {
      position: relative;
    }

    .minimap-node {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      background: #222;
      position: absolute;
    }

    .minimap-node.visited {
      background: #444;
    }

    .minimap-node.current {
      background: #0af;
      box-shadow: 0 0 8px #0af;
    }

    .minimap-node.unknown {
      background: #111;
      opacity: 0.3;
    }

    .minimap-node.has-item::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 8px;
      height: 8px;
      background: #fc0;
      border-radius: 50%;
    }

    /* Connessioni come elementi separati */
    .minimap-conn {
      position: absolute;
      background: #666;
      border-radius: 1px;
    }

    .minimap-conn.locked {
      background: #f44;
    }

    /* Inventory UI - 6x2 grid for 12 slots */
    #inventory {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: none;
      grid-template-columns: repeat(6, 48px);
      grid-template-rows: repeat(2, 48px);
      gap: 6px;
      padding: 12px 16px;
      background: rgba(0, 0, 0, 0.85);
      border: 1px solid #333;
      border-radius: 8px;
      z-index: 100;
    }

    #inventory.active {
      display: grid;
    }

    .inventory-slot {
      width: 48px;
      height: 48px;
      background: #1a1a1a;
      border: 2px solid #333;
      border-radius: 6px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      transition: all 0.15s ease;
    }

    .inventory-slot.selected {
      border-color: #0af;
      box-shadow: 0 0 12px rgba(0, 170, 255, 0.5);
      background: #1a2a3a;
    }

    .inventory-slot.empty {
      opacity: 0.4;
    }

    .inventory-slot .slot-number {
      position: absolute;
      top: 2px;
      left: 4px;
      font-size: 10px;
      color: #666;
      font-weight: bold;
    }

    .inventory-slot.selected .slot-number {
      color: #0af;
    }

    .inventory-slot .item-icon {
      font-size: 20px;
      margin-top: 4px;
    }

    .inventory-slot .item-name {
      font-size: 8px;
      color: #888;
      margin-top: 2px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      max-width: 44px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .inventory-slot.selected .item-name {
      color: #0af;
    }

    /* Controls Help */
    #controls-help {
      position: fixed;
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0, 0, 0, 0.85);
      border: 1px solid #333;
      border-radius: 8px;
      padding: 16px 20px;
      z-index: 100;
      display: none;
    }

    #controls-help.active {
      display: block;
    }

    #controls-help h3 {
      font-size: 12px;
      color: #0af;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .control-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      gap: 16px;
    }

    .control-row:last-child {
      margin-bottom: 0;
    }

    .control-key {
      background: #222;
      border: 1px solid #444;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 11px;
      font-family: monospace;
      color: #fff;
      min-width: 24px;
      text-align: center;
    }

    .control-action {
      font-size: 11px;
      color: #888;
    }

    /* Room Info */
    #room-info {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.85);
      border: 1px solid #333;
      border-radius: 8px;
      padding: 12px 24px;
      z-index: 100;
      text-align: center;
      display: none;
      max-width: 400px;
    }

    #room-info.active {
      display: block;
    }

    #room-info .room-name {
      font-size: 14px;
      color: #0af;
      font-weight: bold;
      margin-bottom: 6px;
    }

    #room-info .room-description {
      font-size: 12px;
      color: #ccc;
      margin-bottom: 8px;
      line-height: 1.4;
      font-style: italic;
    }

    #room-info .room-direction {
      font-size: 11px;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
  </style>
</head>
<body>
  <!-- Pre-splash: requires user interaction to enable audio -->
  <div id="pre-splash">
    <h1>In The Dark</h1>
    <div class="start-prompt">
      <button id="btn-enter">Enter</button>
      <p class="press-key">or press any key</p>
    </div>
  </div>

  <!-- Main splash screen (hidden until user interacts) -->
  <div id="start-screen">
    <h1>In The Dark</h1>
    <p>An audio adventure game</p>
    <p class="version">v0.2.1</p>
    <div class="how-to-play">
      <h2>How to Play</h2>

      <p>
        You are lost in total darkness. Navigate using <kbd>Arrow Keys</kbd> to move and turn.
        Press <kbd>Enter</kbd> to activate your sonar and detect exits, items, and obstacles around you.
      </p>
      <p>
        Collect items with <kbd>Space</kbd> and use them to unlock passages.
        Press <kbd>H</kbd> for hints when you're stuck.
      </p>
      <p>
        Listen carefully - every sound tells a story.
      </p>
      <p class="tip">Use headphones for the best experience!</p>
    </div>
    <div class="options">
      <div class="option-row">
        <input type="checkbox" id="voice-narration" name="voice-narration" checked>
        <label for="voice-narration">Voice Narration (room descriptions)</label>
      </div>
      <div class="option-row">
        <input type="checkbox" id="binaural-audio" name="binaural-audio" checked>
        <label for="binaural-audio">3D Audio / HRTF (use headphones)</label>
      </div>
    </div>
    <div class="buttons">
      <button id="btn-new-game">New Game</button>
      <button id="btn-load-game" class="hidden">Continue</button>
    </div>
  </div>

  <div id="game-screen">
  </div>

  <div id="minimap"></div>

  <div id="room-info">
    <div class="room-name">Forest Path</div>
    <div class="room-description"></div>
    <div class="room-direction">Facing North</div>
  </div>

  <div id="controls-help">
    <h3>Controls</h3>
    <div class="control-row">
      <span class="control-key">&#8593;</span>
      <span class="control-action">Forward</span>
    </div>
    <div class="control-row">
      <span class="control-key">&#8595;</span>
      <span class="control-action">Turn around</span>
    </div>
    <div class="control-row">
      <span class="control-key">&#8592;</span>
      <span class="control-action">Turn left</span>
    </div>
    <div class="control-row">
      <span class="control-key">&#8594;</span>
      <span class="control-action">Turn right</span>
    </div>
    <div class="control-row">
      <span class="control-key">ENTER</span>
      <span class="control-action">Sonar</span>
    </div>
    <div class="control-row">
      <span class="control-key">SPACE</span>
      <span class="control-action">Pick / Use</span>
    </div>
    <div class="control-row">
      <span class="control-key">CTRL</span>
      <span class="control-action">Cycle item</span>
    </div>
    <div class="control-row">
      <span class="control-key">S</span>
      <span class="control-action">Save game</span>
    </div>
    <div class="control-row">
      <span class="control-key">H</span>
      <span class="control-action">Hint</span>
    </div>
    <div class="control-row">
      <span class="control-key">P</span>
      <span class="control-action">Voice toggle</span>
    </div>
  </div>

  <div id="inventory"></div>

  <script>
    // Pre-splash to main splash transition with audio unlock
    const preSplash = document.getElementById('pre-splash');
    const startScreen = document.getElementById('start-screen');
    const btnEnter = document.getElementById('btn-enter');
    let hasEnteredSplash = false;

    // Transition from pre-splash to main splash
    function enterMainSplash() {
      if (hasEnteredSplash) return;
      hasEnteredSplash = true;

      console.log('Entering main splash screen');

      // Hide pre-splash, show main splash
      preSplash.classList.add('hidden');
      startScreen.classList.add('active');

      // Now that we have user interaction, speak the How to Play
      // Small delay to ensure the transition is visible
      setTimeout(speakHowToPlay, 300);
    }

    // Button click
    btnEnter.addEventListener('click', enterMainSplash);

    // Any key press
    document.addEventListener('keydown', function onKeyDown(e) {
      if (!hasEnteredSplash) {
        enterMainSplash();
      }
    });

    // Speak How to Play narration
    function speakHowToPlay() {
      const voices = speechSynthesis.getVoices();

      // If voices not loaded yet, wait for them
      if (voices.length === 0) {
        console.log('HowToPlay: Waiting for voices to load...');
        speechSynthesis.onvoiceschanged = () => {
          speechSynthesis.onvoiceschanged = null;
          speakHowToPlay();
        };
        return;
      }

      console.log('HowToPlay: Speaking with', voices.length, 'voices available');

      // Cancel any stuck utterances
      speechSynthesis.cancel();

      const howToPlayText = `
        Welcome to In The Dark, an audio adventure game.
        You are lost in total darkness. Navigate using Arrow Keys to move and turn.
        Press Enter to activate your sonar and detect exits, items, and obstacles around you.
        Collect items with Space and use them to unlock passages.
        Press H for hints when you're stuck.
        Listen carefully. Every sound tells a story.
        Use headphones for the best experience.
      `;

      const utterance = new SpeechSynthesisUtterance(howToPlayText);
      utterance.rate = 0.95;
      utterance.pitch = 0.7;
      utterance.lang = 'en-US';

      // Select voice with same priority as game narrator
      const preferredVoices = [
        'Microsoft David',
        'Daniel',
        'Alex',
        'Google UK English Male',
        'Microsoft Mark',
        'Thomas',
        'English (America)',
        'English (Great Britain)'
      ];

      let selectedVoice = null;
      for (const preferred of preferredVoices) {
        const found = voices.find(v =>
          v.name.includes(preferred) ||
          v.lang.startsWith(preferred) ||
          v.lang === preferred
        );
        if (found) {
          selectedVoice = found;
          break;
        }
      }

      // Fallback: any English male voice
      if (!selectedVoice) {
        const englishVoices = voices.filter(v =>
          v.lang.startsWith('en-') || v.lang.startsWith('en_')
        );
        selectedVoice = englishVoices.find(v =>
          v.name.toLowerCase().includes('male') && !v.name.toLowerCase().includes('female')
        ) || englishVoices.find(v =>
          !v.name.toLowerCase().includes('female')
        ) || englishVoices[0];
      }

      if (selectedVoice) {
        utterance.voice = selectedVoice;
        console.log('HowToPlay: Using voice:', selectedVoice.name);
      }

      utterance.onstart = () => console.log('HowToPlay: Speech started');
      utterance.onend = () => console.log('HowToPlay: Speech completed');
      utterance.onerror = (e) => console.log('HowToPlay: Speech error:', e.error);

      speechSynthesis.speak(utterance);
    }
  </script>
  <script type="module" src="/src/main.ts"></script>
</body>
</html>
